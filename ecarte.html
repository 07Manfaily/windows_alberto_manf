import React, { useState, useRef, useEffect } from 'react';

const FormationWizard = ({ isOpen = false, onClose = () => {} }) => {
  const [currentStep, setCurrentStep] = useState(1);
  const [validationErrors, setValidationErrors] = useState({});
  const dialogRef = useRef(null);
  
  const [formData, setFormData] = useState({
    step1: {
      year: '',
      intitule_formation: ''
    },
    step2: {
      formation_obligatoire: null
    }
  });

  const steps = [
    { id: 1, title: 'Informations G√©n√©rales', icon: 'üìã' },
    { id: 2, title: 'Configuration', icon: '‚öôÔ∏è' },
    { id: 3, title: 'Finalisation', icon: '‚ú®' }
  ];

  useEffect(() => {
    if (isOpen && dialogRef.current) {
      dialogRef.current.showModal();
    } else if (dialogRef.current) {
      dialogRef.current.close();
    }
  }, [isOpen]);

  const validateStep = (stepNumber) => {
    const newErrors = {};
    
    if (stepNumber === 0) {
      if (!formData.step1.year) {
        newErrors.year = "Ann√©e requise";
      }
      if (!formData.step1.intitule_formation) {
        newErrors.intitule_formation = "Titre requis";
      }
    }
    
    if (stepNumber === 1) {
      if (formData.step2.formation_obligatoire === null) {
        newErrors.formation_obligatoire = "Choix requis";
      }
    }
    
    setValidationErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const nextStep = () => {
    // Valider et afficher les erreurs visuellement
    if (!validateStep(currentStep - 1)) {
      // Les erreurs sont maintenant affich√©es visuellement
      // Pas d'alert, juste le retour anticip√©
      return;
    }
    
    if (currentStep < steps.length) {
      setCurrentStep(currentStep + 1);
      setValidationErrors({});
    }
  };

  const prevStep = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
      setValidationErrors({});
    }
  };

  const handleInputChange = (step, field, value) => {
    setFormData(prev => ({
      ...prev,
      [step]: {
        ...prev[step],
        [field]: value
      }
    }));
  };

  const handleSubmit = () => {
    console.log('Donn√©es:', formData);
    alert('Formation cr√©√©e !');
    onClose();
  };

  const inputStyle = {
    width: '100%',
    padding: '12px',
    border: '1px solid #ddd',
    borderRadius: '8px',
    fontSize: '16px'
  };

  const errorStyle = {
    color: '#ef4444',
    fontSize: '14px',
    marginTop: '4px'
  };

  const buttonStyle = {
    padding: '12px 24px',
    border: 'none',
    borderRadius: '8px',
    fontSize: '16px',
    cursor: 'pointer',
    background: '#667eea',
    color: 'white'
  };

  const renderStep = () => {
    switch (currentStep) {
      case 1:
        return (
          <div>
            <h2>Informations G√©n√©rales</h2>
            
            <div style={{ marginBottom: '20px' }}>
              <label>Ann√©e *</label>
              <input
                type="number"
                value={formData.step1.year}
                onChange={(e) => handleInputChange('step1', 'year', e.target.value)}
                style={{
                  ...inputStyle,
                  borderColor: validationErrors.year ? '#ef4444' : '#ddd'
                }}
                placeholder="2024"
              />
              {validationErrors.year && (
                <div style={errorStyle}>{validationErrors.year}</div>
              )}
            </div>

            <div style={{ marginBottom: '20px' }}>
              <label>Titre de la formation *</label>
              <input
                type="text"
                value={formData.step1.intitule_formation}
                onChange={(e) => handleInputChange('step1', 'intitule_formation', e.target.value)}
                style={{
                  ...inputStyle,
                  borderColor: validationErrors.intitule_formation ? '#ef4444' : '#ddd'
                }}
                placeholder="Nom de la formation"
              />
              {validationErrors.intitule_formation && (
                <div style={errorStyle}>{validationErrors.intitule_formation}</div>
              )}
            </div>
          </div>
        );

      case 2:
        return (
          <div>
            <h2>Configuration</h2>
            
            <div style={{ marginBottom: '20px' }}>
              <label>Formation obligatoire ? *</label>
              <div style={{ 
                marginTop: '10px',
                border: validationErrors.formation_obligatoire ? '2px solid #ef4444' : '2px solid #ddd',
                padding: '15px',
                borderRadius: '8px'
              }}>
                <div style={{ display: 'flex', gap: '20px' }}>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <input
                      type="radio"
                      checked={formData.step2.formation_obligatoire === true}
                      onChange={() => handleInputChange('step2', 'formation_obligatoire', true)}
                    />
                    Oui
                  </label>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <input
                      type="radio"
                      checked={formData.step2.formation_obligatoire === false}
                      onChange={() => handleInputChange('step2', 'formation_obligatoire', false)}
                    />
                    Non
                  </label>
                </div>
              </div>
              {validationErrors.formation_obligatoire && (
                <div style={errorStyle}>{validationErrors.formation_obligatoire}</div>
              )}
            </div>
          </div>
        );

      case 3:
        return (
          <div>
            <h2>Finalisation</h2>
            <p>R√©capitulatif de votre formation :</p>
            <ul>
              <li>Ann√©e : {formData.step1.year}</li>
              <li>Titre : {formData.step1.intitule_formation}</li>
              <li>Obligatoire : {formData.step2.formation_obligatoire ? 'Oui' : 'Non'}</li>
            </ul>
            
            <button onClick={handleSubmit} style={buttonStyle}>
              Cr√©er la Formation
            </button>
          </div>
        );

      default:
        return <div>√âtape inconnue</div>;
    }
  };

  // Version standalone pour test
  if (!isOpen) {
    return (
      <div style={{ padding: '20px' }}>
        <button 
          onClick={() => dialogRef.current?.showModal()}
          style={buttonStyle}
        >
          Ouvrir le formulaire de formation
        </button>
        
        <dialog
          ref={dialogRef}
          style={{
            width: '600px',
            height: '500px',
            border: 'none',
            borderRadius: '12px',
            padding: '0'
          }}
        >
          <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
            <div style={{
              background: '#334155',
              color: 'white',
              padding: '20px',
              position: 'relative'
            }}>
              <button
                onClick={() => dialogRef.current?.close()}
                style={{
                  position: 'absolute',
                  top: '10px',
                  right: '15px',
                  background: 'none',
                  border: 'none',
                  color: 'white',
                  fontSize: '20px',
                  cursor: 'pointer'
                }}
              >
                √ó
              </button>
              <h1 style={{ margin: 0 }}>Assistant de Formation</h1>
              <p style={{ margin: '10px 0 0 0' }}>
                √âtape {currentStep} sur {steps.length} - {steps[currentStep - 1].title}
              </p>
            </div>

            <div style={{ flex: 1, padding: '30px', overflow: 'auto' }}>
              {renderStep()}
            </div>

            <div style={{
              padding: '20px',
              borderTop: '1px solid #ddd',
              display: 'flex',
              justifyContent: 'space-between'
            }}>
              <button
                onClick={prevStep}
                disabled={currentStep === 1}
                style={{
                  ...buttonStyle,
                  background: currentStep === 1 ? '#ccc' : '#6b7280',
                  cursor: currentStep === 1 ? 'not-allowed' : 'pointer'
                }}
              >
                Pr√©c√©dent
              </button>
              
              {currentStep < steps.length && (
                <button onClick={nextStep} style={buttonStyle}>
                  Suivant
                </button>
              )}
            </div>
          </div>
        </dialog>
      </div>
    );
  }

  return null;
};

export default FormationWizard;
