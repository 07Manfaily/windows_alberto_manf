import React, { useState, useEffect } from 'react';
import { Calendar, Building2, Users, FileText, Plus, Search, Download, Edit, Eye, Trash2, Home, TrendingUp, Upload, File, FolderOpen, Save, RefreshCw, FileSpreadsheet, FileImage, ChevronLeft, ChevronRight, Filter, ArrowLeft } from 'lucide-react';

const API_BASE_URL = 'http://10.9.100.115:5010/api/automation_ag';

const App = () => {
  const [currentView, setCurrentView] = useState('dashboard');
  const [entreprises, setEntreprises] = useState([]);
  const [ags, setAgs] = useState([]);
  const [fichiers, setFichiers] = useState([]);
  const [selectedEntreprise, setSelectedEntreprise] = useState(null);
  const [selectedAg, setSelectedAg] = useState(null);
  const [selectedSgi, setSelectedSgi] = useState(null);
  const [selectedFile, setSelectedFile] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [showModal, setShowModal] = useState(false);
  const [modalType, setModalType] = useState('');
  const [loading, setLoading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);

  // États pour la gestion des SGI et fichiers
  const [sgiList, setSgiList] = useState([]);
  const [participants, setParticipants] = useState([]);
  const [loadingParticipants, setLoadingParticipants] = useState(false);
  const [selectedSgiForImport, setSelectedSgiForImport] = useState([]);
  const [importedSgiData, setImportedSgiData] = useState(null);
  const [showSgiImportModal, setShowSgiImportModal] = useState(false);
  
  // États pour la pagination et filtrage
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage] = useState(12);
  const [fileFilter, setFileFilter] = useState('all');
  const [sortBy, setSortBy] = useState('date_desc');

  // Navigation state pour breadcrumb
  const [navigationStack, setNavigationStack] = useState([]);

  // Simulated data loading avec plus de fichiers et structure logique AG→SGI→Files
  useEffect(() => {
    setEntreprises([
      { id: 1, nom_entreprise: "TechCorp SA", entreprise_id: 1, created_at: "2024-01-15" },
      { id: 2, nom_entreprise: "InnoVest Partners", entreprise_id: 2, created_at: "2024-02-20" }
    ]);
    
    setAgs([
      { 
        id: 1, 
        code_ag: "AG2026-001", 
        date_ag: "2026-03-15", 
        entreprise_id: 1,
        nom_entreprise: "TechCorp SA",
        fichiers_count: 45,
        participants_count: 105,
        sgi_count: 3
      },
      { 
        id: 2, 
        code_ag: "AG2026-002", 
        date_ag: "2026-04-20", 
        entreprise_id: 1,
        nom_entreprise: "TechCorp SA",
        fichiers_count: 32,
        participants_count: 87,
        sgi_count: 2
      }
    ]);

    // SGI avec association aux AG
    setSgiList([
      {
        id: 1,
        nom_sgi: "SGI Alpha Investments",
        sgi_id: "SGI001",
        participants_count: 45,
        total_actions: 15000,
        status: "active",
        ag_id: 1,
        files_count: 18
      },
      {
        id: 2,
        nom_sgi: "SGI Beta Finance",
        sgi_id: "SGI002", 
        participants_count: 35,
        total_actions: 12500,
        status: "active",
        ag_id: 1,
        files_count: 15
      },
      {
        id: 3,
        nom_sgi: "SGI Gamma Capital",
        sgi_id: "SGI003",
        participants_count: 25,
        total_actions: 9800,
        status: "active",
        ag_id: 1,
        files_count: 12
      },
      {
        id: 4,
        nom_sgi: "SGI Delta Partners",
        sgi_id: "SGI004",
        participants_count: 42,
        total_actions: 11200,
        status: "active",
        ag_id: 2,
        files_count: 20
      },
      {
        id: 5,
        nom_sgi: "SGI Epsilon Holdings",
        sgi_id: "SGI005",
        participants_count: 45,
        total_actions: 13800,
        status: "active",
        ag_id: 2,
        files_count: 12
      }
    ]);

    // Simulation avec beaucoup de fichiers par SGI
    const mockFiles = [];
    for (let i = 1; i <= 120; i++) {
      const sgiId = `SGI00${Math.floor(Math.random() * 5) + 1}`;
      const agId = sgiId <= 'SGI003' ? 1 : 2;
      
      mockFiles.push({
        id: i,
        nom_fichier: `fichier_${i.toString().padStart(3, '0')}_${['actionnaires', 'participants', 'rapport', 'votes', 'presence'][Math.floor(Math.random() * 5)]}.${['xlsx', 'csv', 'pdf'][Math.floor(Math.random() * 3)]}`,
        type: ['xlsx', 'csv', 'pdf'][Math.floor(Math.random() * 3)],
        taille: `${(Math.random() * 5 + 0.1).toFixed(1)} MB`,
        date_upload: new Date(2026, 0, Math.floor(Math.random() * 30) + 1, Math.floor(Math.random() * 24), Math.floor(Math.random() * 60)).toISOString(),
        ag_id: agId,
        sgi_id: sgiId,
        status: Math.random() > 0.2 ? "processed" : "processing",
        // Contenu simulé du fichier pour l'édition
        content: generateMockFileContent(sgiId)
      });
    }
    setFichiers(mockFiles);
  }, []);

  // Fonction pour générer du contenu simulé de fichier
  const generateMockFileContent = (sgiId) => {
    const sgi = sgiList.find(s => s.sgi_id === sgiId) || { nom_sgi: "SGI Simulé" };
    const participants = [];
    
    // Générer des participants simulés pour ce SGI
    const names = ["Dupont Jean", "Martin Sophie", "Bernard Pierre", "Petit Marie", "Dubois Thomas", "Laurent Claire", "Moreau Lucas", "Simon Emma", "Roux Pierre", "Blanc Marie"];
    for (let i = 0; i < 10; i++) {
      participants.push({
        nom_client: names[i] || `Client ${i+1}`,
        nombre_actions: Math.floor(Math.random() * 5000) + 500,
        user_id: i + 1,
        sgi_id: sgiId
      });
    }
    
    return {
      sgi_info: sgi,
      participants: participants,
      total_actions: participants.reduce((acc, p) => acc + p.nombre_actions, 0),
      last_modified: new Date().toISOString()
    };
  };

  const openModal = (type) => {
    setModalType(type);
    setShowModal(true);
  };

  const closeModal = () => {
    setShowModal(false);
    setModalType('');
    setSelectedFile(null);
  };

  // Navigation helpers
  const pushNavigation = (view, data) => {
    setNavigationStack(prev => [...prev, { view, data }]);
  };

  const popNavigation = () => {
    if (navigationStack.length > 0) {
      const newStack = [...navigationStack];
      newStack.pop();
      setNavigationStack(newStack);
      
      // Réinitialiser les états selon la navigation
      if (newStack.length === 0) {
        setSelectedAg(null);
        setSelectedSgi(null);
        setSelectedFile(null);
      } else {
        const lastItem = newStack[newStack.length - 1];
        if (lastItem.view === 'ag') {
          setSelectedSgi(null);
          setSelectedFile(null);
        } else if (lastItem.view === 'sgi') {
          setSelectedFile(null);
        }
      }
    }
  };

  // Fonctions de gestion des fichiers
  const handleFileUpload = async (file, agId, sgiId) => {
    setLoading(true);
    setUploadProgress(0);
    
    // Simulation d'upload avec progression
    for (let i = 0; i <= 100; i += 10) {
      await new Promise(resolve => setTimeout(resolve, 100));
      setUploadProgress(i);
    }

    const newFile = {
      id: fichiers.length + 1,
      nom_fichier: file.name,
      type: file.name.split('.').pop(),
      taille: (file.size / (1024*1024)).toFixed(2) + " MB",
      date_upload: new Date().toISOString(),
      ag_id: agId,
      sgi_id: sgiId,
      status: "processing",
      content: generateMockFileContent(sgiId)
    };

    setFichiers([...fichiers, newFile]);
    
    setLoading(false);
    setUploadProgress(0);
    
    // Simulation du traitement
    setTimeout(() => {
      setFichiers(prev => prev.map(f => 
        f.id === newFile.id ? {...f, status: "processed"} : f
      ));
    }, 3000);
  };

  // Navigation Component
  const Navigation = () => (
    <div style={{
      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      padding: '20px 40px',
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
    }}>
      <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
        <Calendar size={32} color="white" />
        <h1 style={{ color: 'white', margin: 0, fontSize: '24px', fontWeight: 'bold' }}>
          AG Online Pro
        </h1>
      </div>
      <div style={{ display: 'flex', gap: '20px' }}>
        {[
          { id: 'dashboard', icon: Home, label: 'Dashboard' },
          { id: 'entreprises', icon: Building2, label: 'Entreprises' },
          { id: 'ags', icon: Calendar, label: 'Assemblées' },
          { id: 'actionnaires', icon: Users, label: 'Actionnaires' },
          { id: 'participants', icon: Users, label: 'Participants' },
          { id: 'rapports', icon: FileText, label: 'Rapports' }
        ].map(item => (
          <button
            key={item.id}
            onClick={() => {
              setCurrentView(item.id);
              setNavigationStack([]);
              setSelectedAg(null);
              setSelectedSgi(null);
              setSelectedFile(null);
            }}
            style={{
              background: currentView === item.id ? 'rgba(255,255,255,0.3)' : 'transparent',
              color: 'white',
              border: 'none',
              padding: '10px 20px',
              borderRadius: '8px',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              fontSize: '14px',
              fontWeight: '500',
              transition: 'all 0.3s ease'
            }}
            onMouseEnter={(e) => e.target.style.background = 'rgba(255,255,255,0.2)'}
            onMouseLeave={(e) => e.target.style.background = currentView === item.id ? 'rgba(255,255,255,0.3)' : 'transparent'}
          >
            <item.icon size={18} />
            {item.label}
          </button>
        ))}
      </div>
    </div>
  );

  // Breadcrumb Component
  const Breadcrumb = () => {
    if (navigationStack.length === 0) return null;

    const getBreadcrumbItems = () => {
      const items = [];
      
      navigationStack.forEach((item, index) => {
        switch (item.view) {
          case 'ag':
            items.push({ label: item.data.code_ag, icon: Calendar });
            break;
          case 'sgi':
            items.push({ label: item.data.nom_sgi, icon: TrendingUp });
            break;
          case 'file':
            items.push({ label: "Édition fichier", icon: Edit });
            break;
          default:
            break;
        }
      });
      
      return items;
    };

    const breadcrumbItems = getBreadcrumbItems();

    return (
      <div style={{
        background: 'white',
        padding: '15px 40px',
        display: 'flex',
        alignItems: 'center',
        gap: '15px',
        borderBottom: '1px solid #e5e7eb',
        fontSize: '14px'
      }}>
        <button
          onClick={popNavigation}
          style={{
            background: '#f3f4f6',
            color: '#374151',
            border: 'none',
            padding: '8px 12px',
            borderRadius: '6px',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            gap: '6px',
            fontSize: '14px'
          }}
        >
          <ArrowLeft size={16} />
          Retour
        </button>
        
        <div style={{ display: 'flex', alignItems: 'center', gap: '10px', color: '#6b7280' }}>
          <Calendar size={16} />
          <span>Assemblées</span>
          {breadcrumbItems.map((item, index) => (
            <React.Fragment key={index}>
              <span>›</span>
              <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                <item.icon size={16} />
                <span style={{ color: '#1a202c', fontWeight: '500' }}>{item.label}</span>
              </div>
            </React.Fragment>
          ))}
        </div>
      </div>
    );
  };

  // Dashboard Component
  const Dashboard = () => (
    <div style={{ padding: '40px' }}>
      <h2 style={{ fontSize: '28px', marginBottom: '30px', color: '#1a202c' }}>
        Tableau de Bord
      </h2>
      
      <div style={{ 
        display: 'grid', 
        gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', 
        gap: '20px',
        marginBottom: '40px'
      }}>
        {[
          { icon: Building2, label: 'Entreprises', value: entreprises.length, color: '#667eea', bg: '#e0e7ff' },
          { icon: Calendar, label: 'AG Planifiées', value: ags.length, color: '#f59e0b', bg: '#fef3c7' },
          { icon: TrendingUp, label: 'SGI Participants', value: sgiList.length, color: '#10b981', bg: '#d1fae5' },
          { icon: FolderOpen, label: 'Fichiers Totaux', value: fichiers.length, color: '#ef4444', bg: '#fee2e2' }
        ].map((stat, index) => (
          <div key={index} style={{
            background: 'white',
            padding: '25px',
            borderRadius: '12px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
            display: 'flex',
            alignItems: 'center',
            gap: '20px',
            transition: 'transform 0.3s ease',
            cursor: 'pointer'
          }}
          onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
          onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
          >
            <div style={{
              background: stat.bg,
              padding: '15px',
              borderRadius: '10px'
            }}>
              <stat.icon size={28} color={stat.color} />
            </div>
            <div>
              <div style={{ fontSize: '14px', color: '#6b7280', marginBottom: '5px' }}>
                {stat.label}
              </div>
              <div style={{ fontSize: '28px', fontWeight: 'bold', color: '#1a202c' }}>
                {stat.value}
              </div>
            </div>
          </div>
        ))}
      </div>

      <div style={{ 
        display: 'grid',
        gridTemplateColumns: '2fr 1fr',
        gap: '30px'
      }}>
        <div style={{ 
          background: 'white', 
          padding: '30px', 
          borderRadius: '12px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
        }}>
          <h3 style={{ fontSize: '20px', marginBottom: '20px', color: '#1a202c' }}>
            Prochaines Assemblées Générales
          </h3>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
            {ags.slice(0, 5).map(ag => (
              <div key={ag.id} style={{
                padding: '20px',
                background: '#f9fafb',
                borderRadius: '8px',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center'
              }}>
                <div>
                  <div style={{ fontWeight: 'bold', fontSize: '16px', color: '#1a202c', marginBottom: '5px' }}>
                    {ag.code_ag}
                  </div>
                  <div style={{ fontSize: '14px', color: '#6b7280' }}>
                    {ag.nom_entreprise} • {new Date(ag.date_ag).toLocaleDateString('fr-FR')}
                  </div>
                  <div style={{ fontSize: '12px', color: '#6b7280', marginTop: '4px' }}>
                    {ag.sgi_count} SGI • {ag.participants_count} participants • {ag.fichiers_count} fichiers
                  </div>
                </div>
                <button 
                  onClick={() => {
                    setCurrentView('ags');
                    setSelectedAg(ag);
                    pushNavigation('ag', ag);
                  }}
                  style={{
                    background: '#667eea',
                    color: 'white',
                    border: 'none',
                    padding: '10px 20px',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    fontSize: '14px'
                  }}
                >
                  Voir détails
                </button>
              </div>
            ))}
          </div>
        </div>

        <div style={{ 
          background: 'white', 
          padding: '30px', 
          borderRadius: '12px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
        }}>
          <h3 style={{ fontSize: '20px', marginBottom: '20px', color: '#1a202c' }}>
            Activité Récente
          </h3>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
            {fichiers.slice(0, 6).map(file => (
              <div key={file.id} style={{
                padding: '15px',
                background: '#f9fafb',
                borderRadius: '8px',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <div style={{
                    background: file.status === 'processed' ? '#10b981' : '#f59e0b',
                    padding: '8px',
                    borderRadius: '6px'
                  }}>
                    <File size={16} color="white" />
                  </div>
                  <div>
                    <div style={{ fontSize: '14px', fontWeight: '500', color: '#1a202c' }}>
                      {file.nom_fichier}
                    </div>
                    <div style={{ fontSize: '12px', color: '#6b7280' }}>
                      {sgiList.find(s => s.sgi_id === file.sgi_id)?.nom_sgi || 'SGI N/A'}
                    </div>
                  </div>
                </div>
                <div style={{
                  background: file.status === 'processed' ? '#d1fae5' : '#fef3c7',
                  color: file.status === 'processed' ? '#065f46' : '#92400e',
                  padding: '4px 10px',
                  borderRadius: '12px',
                  fontSize: '11px',
                  fontWeight: '500'
                }}>
                  {file.status === 'processed' ? 'Traité' : 'En cours'}
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );

  // Fonction utilitaire pour les icônes de fichiers
  const getFileIcon = (type) => {
    switch (type) {
      case 'excel':
      case 'xlsx':
        return <FileSpreadsheet size={20} color="#10b981" />;
      case 'pdf':
        return <FileText size={20} color="#ef4444" />;
      case 'csv':
        return <FileSpreadsheet size={20} color="#f59e0b" />;
      case 'image':
      case 'jpg':
      case 'png':
        return <FileImage size={20} color="#8b5cf6" />;
      default:
        return <File size={20} color="#6b7280" />;
    }
  };

  // Composant de pagination
  const Pagination = ({ currentPage, totalPages, onPageChange }) => {
    const pageNumbers = [];
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);

    for (let i = startPage; i <= endPage; i++) {
      pageNumbers.push(i);
    }

    return (
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        gap: '10px',
        marginTop: '30px'
      }}>
        <button
          onClick={() => onPageChange(currentPage - 1)}
          disabled={currentPage === 1}
          style={{
            background: currentPage === 1 ? '#f3f4f6' : '#667eea',
            color: currentPage === 1 ? '#9ca3af' : 'white',
            border: 'none',
            padding: '8px 12px',
            borderRadius: '6px',
            cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
            display: 'flex',
            alignItems: 'center',
            gap: '6px'
          }}
        >
          <ChevronLeft size={16} />
          Précédent
        </button>

        {pageNumbers.map(page => (
          <button
            key={page}
            onClick={() => onPageChange(page)}
            style={{
              background: page === currentPage ? '#667eea' : 'white',
              color: page === currentPage ? 'white' : '#374151',
              border: '1px solid #e5e7eb',
              padding: '8px 12px',
              borderRadius: '6px',
              cursor: 'pointer',
              minWidth: '40px'
            }}
          >
            {page}
          </button>
        ))}

        <button
          onClick={() => onPageChange(currentPage + 1)}
          disabled={currentPage === totalPages}
          style={{
            background: currentPage === totalPages ? '#f3f4f6' : '#667eea',
            color: currentPage === totalPages ? '#9ca3af' : 'white',
            border: 'none',
            padding: '8px 12px',
            borderRadius: '6px',
            cursor: currentPage === totalPages ? 'not-allowed' : 'pointer',
            display: 'flex',
            alignItems: 'center',
            gap: '6px'
          }}
        >
          Suivant
          <ChevronRight size={16} />
        </button>
      </div>
    );
  };

  // Vue Assemblées Générales avec flow AG → SGI → Fichiers
  const AGsView = () => {
    // Vue d'édition de fichier
    if (selectedFile) {
      const [editedContent, setEditedContent] = useState(selectedFile.content);

      const handleSaveFile = () => {
        setFichiers(prev => prev.map(f => 
          f.id === selectedFile.id 
            ? { ...f, content: editedContent, last_modified: new Date().toISOString() }
            : f
        ));
        alert('Fichier sauvegardé avec succès !');
      };

      return (
        <div style={{ padding: '40px' }}>
          <Breadcrumb />
          
          <div style={{
            background: 'white',
            padding: '40px',
            borderRadius: '12px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h2 style={{ fontSize: '24px', marginBottom: '30px', color: '#1a202c' }}>
              Édition du fichier: {selectedFile.nom_fichier}
            </h2>

            <div style={{ 
              display: 'grid',
              gridTemplateColumns: '1fr 1fr',
              gap: '30px',
              marginBottom: '30px'
            }}>
              <div>
                <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500' }}>
                  Nom du fichier
                </label>
                <input
                  type="text"
                  value={selectedFile.nom_fichier}
                  onChange={(e) => setSelectedFile(prev => ({ ...prev, nom_fichier: e.target.value }))}
                  style={{
                    width: '100%',
                    padding: '12px',
                    borderRadius: '8px',
                    border: '1px solid #e5e7eb',
                    fontSize: '14px'
                  }}
                />
              </div>
              <div>
                <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500' }}>
                  SGI Associé
                </label>
                <input
                  type="text"
                  value={editedContent.sgi_info.nom_sgi}
                  disabled
                  style={{
                    width: '100%',
                    padding: '12px',
                    borderRadius: '8px',
                    border: '1px solid #e5e7eb',
                    fontSize: '14px',
                    background: '#f9fafb',
                    color: '#6b7280'
                  }}
                />
              </div>
            </div>

            <div style={{ marginBottom: '30px' }}>
              <h3 style={{ fontSize: '18px', marginBottom: '15px', color: '#1a202c' }}>
                Contenu du fichier - Liste des participants ({editedContent.participants.length})
              </h3>
              
              <div style={{
                border: '1px solid #e5e7eb',
                borderRadius: '8px',
                overflow: 'hidden'
              }}>
                {/* Header du tableau */}
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: '2fr 1fr 1fr 1fr',
                  gap: '15px',
                  padding: '15px',
                  background: '#f9fafb',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#374151',
                  borderBottom: '1px solid #e5e7eb'
                }}>
                  <div>Nom du Client</div>
                  <div>User ID</div>
                  <div>Nombre d'Actions</div>
                  <div>Actions</div>
                </div>

                {/* Contenu éditable */}
                <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                  {editedContent.participants.map((participant, index) => (
                    <div key={index} style={{
                      display: 'grid',
                      gridTemplateColumns: '2fr 1fr 1fr 1fr',
                      gap: '15px',
                      padding: '15px',
                      borderBottom: index < editedContent.participants.length - 1 ? '1px solid #f3f4f6' : 'none',
                      alignItems: 'center',
                      fontSize: '14px',
                      background: index % 2 === 0 ? '#ffffff' : '#fafafa'
                    }}>
                      <input
                        type="text"
                        value={participant.nom_client}
                        onChange={(e) => {
                          const newParticipants = [...editedContent.participants];
                          newParticipants[index].nom_client = e.target.value;
                          setEditedContent(prev => ({ ...prev, participants: newParticipants }));
                        }}
                        style={{
                          padding: '8px',
                          borderRadius: '4px',
                          border: '1px solid #e5e7eb',
                          fontSize: '14px'
                        }}
                      />
                      
                      <input
                        type="number"
                        value={participant.user_id}
                        onChange={(e) => {
                          const newParticipants = [...editedContent.participants];
                          newParticipants[index].user_id = parseInt(e.target.value);
                          setEditedContent(prev => ({ ...prev, participants: newParticipants }));
                        }}
                        style={{
                          padding: '8px',
                          borderRadius: '4px',
                          border: '1px solid #e5e7eb',
                          fontSize: '14px'
                        }}
                      />
                      
                      <input
                        type="number"
                        value={participant.nombre_actions}
                        onChange={(e) => {
                          const newParticipants = [...editedContent.participants];
                          newParticipants[index].nombre_actions = parseInt(e.target.value);
                          setEditedContent(prev => ({ 
                            ...prev, 
                            participants: newParticipants,
                            total_actions: newParticipants.reduce((acc, p) => acc + p.nombre_actions, 0)
                          }));
                        }}
                        style={{
                          padding: '8px',
                          borderRadius: '4px',
                          border: '1px solid #e5e7eb',
                          fontSize: '14px'
                        }}
                      />
                      
                      <button
                        onClick={() => {
                          const newParticipants = editedContent.participants.filter((_, i) => i !== index);
                          setEditedContent(prev => ({ 
                            ...prev, 
                            participants: newParticipants,
                            total_actions: newParticipants.reduce((acc, p) => acc + p.nombre_actions, 0)
                          }));
                        }}
                        style={{
                          background: '#ef4444',
                          color: 'white',
                          border: 'none',
                          padding: '6px 12px',
                          borderRadius: '4px',
                          cursor: 'pointer',
                          fontSize: '12px'
                        }}
                      >
                        Supprimer
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Statistiques */}
            <div style={{
              background: '#f0f9ff',
              padding: '20px',
              borderRadius: '8px',
              marginBottom: '30px'
            }}>
              <h4 style={{ fontSize: '16px', marginBottom: '10px', color: '#1e40af' }}>
                Statistiques du fichier
              </h4>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px' }}>
                <div>
                  <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#1d4ed8' }}>
                    {editedContent.participants.length}
                  </div>
                  <div style={{ fontSize: '14px', color: '#2563eb' }}>Participants</div>
                </div>
                <div>
                  <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#1d4ed8' }}>
                    {editedContent.total_actions?.toLocaleString() || 0}
                  </div>
                  <div style={{ fontSize: '14px', color: '#2563eb' }}>Actions Total</div>
                </div>
                <div>
                  <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#1d4ed8' }}>
                    {new Date(editedContent.last_modified).toLocaleDateString('fr-FR')}
                  </div>
                  <div style={{ fontSize: '14px', color: '#2563eb' }}>Dernière Modif</div>
                </div>
              </div>
            </div>

            <div style={{ display: 'flex', gap: '15px' }}>
              <button
                onClick={handleSaveFile}
                style={{
                  background: '#10b981',
                  color: 'white',
                  border: 'none',
                  padding: '12px 24px',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '500',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}
              >
                <Save size={18} />
                Sauvegarder
              </button>
              
              <button
                onClick={() => {
                  const newParticipant = {
                    nom_client: `Nouveau Client ${editedContent.participants.length + 1}`,
                    user_id: editedContent.participants.length + 1,
                    nombre_actions: 1000,
                    sgi_id: editedContent.sgi_info.sgi_id
                  };
                  setEditedContent(prev => ({ 
                    ...prev, 
                    participants: [...prev.participants, newParticipant],
                    total_actions: prev.total_actions + newParticipant.nombre_actions
                  }));
                }}
                style={{
                  background: '#667eea',
                  color: 'white',
                  border: 'none',
                  padding: '12px 24px',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '500',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}
              >
                <Plus size={18} />
                Ajouter Participant
              </button>
              
              <button
                onClick={popNavigation}
                style={{
                  background: '#6b7280',
                  color: 'white',
                  border: 'none',
                  padding: '12px 24px',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '500'
                }}
              >
                Annuler
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Vue des fichiers d'un SGI
    if (selectedSgi) {
      const sgiFiles = fichiers.filter(f => f.sgi_id === selectedSgi.sgi_id);
      
      // Filtrage et tri des fichiers
      const filteredFiles = sgiFiles.filter(file => {
        const matchesSearch = file.nom_fichier.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesFilter = fileFilter === 'all' || file.type === fileFilter;
        return matchesSearch && matchesFilter;
      });

      // Tri des fichiers
      const sortedFiles = [...filteredFiles].sort((a, b) => {
        switch (sortBy) {
          case 'name_asc':
            return a.nom_fichier.localeCompare(b.nom_fichier);
          case 'name_desc':
            return b.nom_fichier.localeCompare(a.nom_fichier);
          case 'date_desc':
            return new Date(b.date_upload) - new Date(a.date_upload);
          case 'date_asc':
            return new Date(a.date_upload) - new Date(b.date_upload);
          case 'size_desc':
            return parseFloat(b.taille) - parseFloat(a.taille);
          case 'size_asc':
            return parseFloat(a.taille) - parseFloat(b.taille);
          default:
            return 0;
        }
      });

      // Pagination
      const totalPages = Math.ceil(sortedFiles.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const paginatedFiles = sortedFiles.slice(startIndex, startIndex + itemsPerPage);

      return (
        <div style={{ padding: '40px' }}>
          <Breadcrumb />
          
          {/* Header avec infos SGI */}
          <div style={{
            background: 'white',
            padding: '30px',
            borderRadius: '12px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
            marginBottom: '30px'
          }}>
            <div style={{
              background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              padding: '25px',
              borderRadius: '12px',
              marginBottom: '25px',
              color: 'white'
            }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div>
                  <h2 style={{ fontSize: '28px', margin: 0, marginBottom: '10px' }}>
                    {selectedSgi.nom_sgi}
                  </h2>
                  <div style={{ opacity: 0.9, fontSize: '14px' }}>
                    AG: {selectedAg.code_ag} • ID: {selectedSgi.sgi_id} • Status: {selectedSgi.status}
                  </div>
                </div>
                <div style={{ textAlign: 'right' }}>
                  <div style={{ fontSize: '32px', fontWeight: 'bold' }}>
                    {sgiFiles.length}
                  </div>
                  <div style={{ fontSize: '14px', opacity: 0.9 }}>
                    fichiers associés
                  </div>
                </div>
              </div>
            </div>

            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(3, 1fr)',
              gap: '20px',
              marginBottom: '25px'
            }}>
              <div style={{ background: '#f0fdf4', padding: '20px', borderRadius: '8px', textAlign: 'center' }}>
                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#166534' }}>
                  {selectedSgi.participants_count}
                </div>
                <div style={{ fontSize: '14px', color: '#16a34a' }}>Participants</div>
              </div>
              <div style={{ background: '#eff6ff', padding: '20px', borderRadius: '8px', textAlign: 'center' }}>
                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#1d4ed8' }}>
                  {selectedSgi.total_actions.toLocaleString()}
                </div>
                <div style={{ fontSize: '14px', color: '#2563eb' }}>Actions</div>
              </div>
              <div style={{ background: '#fef3c7', padding: '20px', borderRadius: '8px', textAlign: 'center' }}>
                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#d97706' }}>
                  {sgiFiles.filter(f => f.status === 'processed').length}
                </div>
                <div style={{ fontSize: '14px', color: '#f59e0b' }}>Fichiers traités</div>
              </div>
            </div>

            {/* Actions rapides */}
            <div style={{ display: 'flex', gap: '15px' }}>
              <button
                onClick={() => openModal('upload-sgi')}
                style={{
                  background: '#10b981',
                  color: 'white',
                  border: 'none',
                  padding: '12px 24px',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  fontSize: '14px',
                  fontWeight: '500'
                }}
              >
                <Upload size={18} />
                Upload Fichier
              </button>
            </div>
          </div>

          {/* Section fichiers */}
          <div style={{
            background: 'white',
            padding: '30px',
            borderRadius: '12px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h3 style={{ fontSize: '20px', color: '#1a202c', marginBottom: '20px' }}>
              Fichiers du SGI ({sgiFiles.length})
            </h3>

            {/* Barre d'outils */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: '2fr 1fr 1fr',
              gap: '15px',
              marginBottom: '25px',
              alignItems: 'end'
            }}>
              <div>
                <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500' }}>
                  Rechercher
                </label>
                <div style={{ position: 'relative' }}>
                  <Search size={20} color="#9ca3af" style={{ 
                    position: 'absolute', 
                    left: '12px', 
                    top: '50%', 
                    transform: 'translateY(-50%)' 
                  }} />
                  <input
                    type="text"
                    placeholder="Nom du fichier..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    style={{
                      width: '100%',
                      padding: '12px 12px 12px 45px',
                      borderRadius: '8px',
                      border: '1px solid #e5e7eb',
                      fontSize: '14px',
                      outline: 'none'
                    }}
                  />
                </div>
              </div>

              <div>
                <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500' }}>
                  Type
                </label>
                <select
                  value={fileFilter}
                  onChange={(e) => setFileFilter(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '12px',
                    borderRadius: '8px',
                    border: '1px solid #e5e7eb',
                    fontSize: '14px',
                    outline: 'none'
                  }}
                >
                  <option value="all">Tous les types</option>
                  <option value="xlsx">Excel</option>
                  <option value="csv">CSV</option>
                  <option value="pdf">PDF</option>
                </select>
              </div>

              <div>
                <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500' }}>
                  Trier par
                </label>
                <select
                  value={sortBy}
                  onChange={(e) => setSortBy(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '12px',
                    borderRadius: '8px',
                    border: '1px solid #e5e7eb',
                    fontSize: '14px',
                    outline: 'none'
                  }}
                >
                  <option value="date_desc">Plus récent</option>
                  <option value="date_asc">Plus ancien</option>
                  <option value="name_asc">Nom A-Z</option>
                  <option value="name_desc">Nom Z-A</option>
                  <option value="size_desc">Taille (grand → petit)</option>
                  <option value="size_asc">Taille (petit → grand)</option>
                </select>
              </div>
            </div>

            {/* Affichage des fichiers */}
            {paginatedFiles.length > 0 ? (
              <div>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: '3fr 1fr 1fr 1fr 2fr',
                  gap: '15px',
                  padding: '15px',
                  background: '#f9fafb',
                  borderRadius: '8px',
                  marginBottom: '10px',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#374151'
                }}>
                  <div>Fichier</div>
                  <div>Type</div>
                  <div>Taille</div>
                  <div>Status</div>
                  <div>Actions</div>
                </div>

                {paginatedFiles.map(file => (
                  <div key={file.id} style={{
                    display: 'grid',
                    gridTemplateColumns: '3fr 1fr 1fr 1fr 2fr',
                    gap: '15px',
                    padding: '15px',
                    borderBottom: '1px solid #f3f4f6',
                    alignItems: 'center',
                    fontSize: '14px',
                    transition: 'background 0.3s ease'
                  }}
                  onMouseEnter={(e) => e.currentTarget.style.background = '#f9fafb'}
                  onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                      {getFileIcon(file.type)}
                      <div>
                        <div style={{ fontWeight: '500', color: '#1a202c' }}>
                          {file.nom_fichier}
                        </div>
                        <div style={{ fontSize: '12px', color: '#6b7280' }}>
                          {new Date(file.date_upload).toLocaleDateString('fr-FR')}
                        </div>
                      </div>
                    </div>

                    <div style={{
                      background: '#e0e7ff',
                      color: '#4338ca',
                      padding: '4px 10px',
                      borderRadius: '12px',
                      fontSize: '12px',
                      fontWeight: '500',
                      textAlign: 'center',
                      textTransform: 'uppercase'
                    }}>
                      {file.type}
                    </div>

                    <div style={{ color: '#6b7280' }}>
                      {file.taille}
                    </div>

                    <div style={{
                      background: file.status === 'processed' ? '#d1fae5' : '#fef3c7',
                      color: file.status === 'processed' ? '#065f46' : '#92400e',
                      padding: '4px 10px',
                      borderRadius: '12px',
                      fontSize: '12px',
                      fontWeight: '500',
                      textAlign: 'center'
                    }}>
                      {file.status === 'processed' ? 'Traité' : 'En cours'}
                    </div>

                    <div style={{ display: 'flex', gap: '8px' }}>
                      <button
                        onClick={() => {
                          setSelectedFile(file);
                          pushNavigation('file', file);
                        }}
                        style={{
                          background: '#667eea',
                          color: 'white',
                          border: 'none',
                          padding: '6px 12px',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '12px',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '6px'
                        }}
                      >
                        <Edit size={14} />
                        Éditer
                      </button>
                      <button
                        style={{
                          background: '#10b981',
                          color: 'white',
                          border: 'none',
                          padding: '6px 12px',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '12px',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '6px'
                        }}
                      >
                        <Download size={14} />
                      </button>
                      <button
                        style={{
                          background: '#ef4444',
                          color: 'white',
                          border: 'none',
                          padding: '6px',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center'
                        }}
                      >
                        <Trash2 size={14} />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div style={{
                textAlign: 'center',
                padding: '60px',
                color: '#6b7280',
                background: '#f9fafb',
                borderRadius: '8px'
              }}>
                <File size={48} color="#d1d5db" style={{ margin: '0 auto 15px' }} />
                <p>Aucun fichier trouvé</p>
                {(fileFilter !== 'all' || searchTerm) && (
                  <button
                    onClick={() => {
                      setFileFilter('all');
                      setSearchTerm('');
                    }}
                    style={{
                      background: '#667eea',
                      color: 'white',
                      border: 'none',
                      padding: '8px 16px',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      fontSize: '14px',
                      marginTop: '10px'
                    }}
                  >
                    Réinitialiser les filtres
                  </button>
                )}
              </div>
            )}

            {/* Pagination */}
            {totalPages > 1 && (
              <Pagination
                currentPage={currentPage}
                totalPages={totalPages}
                onPageChange={setCurrentPage}
              />
            )}

            {/* Info résultats */}
            <div style={{
              textAlign: 'center',
              marginTop: '20px',
              fontSize: '14px',
              color: '#6b7280'
            }}>
              Affichage {startIndex + 1} à {Math.min(startIndex + itemsPerPage, sortedFiles.length)} sur {sortedFiles.length} fichiers
            </div>
          </div>
        </div>
      );
    }

    // Vue des SGI d'une AG
    if (selectedAg) {
      const agSgis = sgiList.filter(sgi => sgi.ag_id === selectedAg.id);
      
      const handleSgiClick = (sgi) => {
        setSelectedSgi(sgi);
        pushNavigation('sgi', sgi);
        setCurrentPage(1); // Reset pagination
      };

      return (
        <div style={{ padding: '40px' }}>
          <Breadcrumb />
          
          <div style={{
            background: 'white',
            padding: '30px',
            borderRadius: '12px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
            marginBottom: '30px'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '20px' }}>
              <div>
                <h2 style={{ fontSize: '28px', color: '#1a202c', marginBottom: '10px' }}>
                  {selectedAg.code_ag}
                </h2>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <Building2 size={18} color="#667eea" />
                    <span style={{ fontSize: '16px', color: '#6b7280' }}>
                      {selectedAg.nom_entreprise}
                    </span>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <Calendar size={18} color="#10b981" />
                    <span style={{ fontSize: '16px', color: '#6b7280' }}>
                      {new Date(selectedAg.date_ag).toLocaleDateString('fr-FR', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                      })}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(4, 1fr)',
              gap: '20px',
              marginTop: '20px'
            }}>
              <div style={{
                background: '#f9fafb',
                padding: '20px',
                borderRadius: '8px'
              }}>
                <div style={{ fontSize: '13px', color: '#6b7280', marginBottom: '5px' }}>
                  SGI Participants
                </div>
                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#1a202c' }}>
                  {agSgis.length}
                </div>
              </div>
              <div style={{
                background: '#f9fafb',
                padding: '20px',
                borderRadius: '8px'
              }}>
                <div style={{ fontSize: '13px', color: '#6b7280', marginBottom: '5px' }}>
                  Total Participants
                </div>
                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#1a202c' }}>
                  {selectedAg.participants_count}
                </div>
              </div>
              <div style={{
                background: '#f9fafb',
                padding: '20px',
                borderRadius: '8px'
              }}>
                <div style={{ fontSize: '13px', color: '#6b7280', marginBottom: '5px' }}>
                  Total Fichiers
                </div>
                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#1a202c' }}>
                  {selectedAg.fichiers_count}
                </div>
              </div>
              <div style={{
                background: '#f9fafb',
                padding: '20px',
                borderRadius: '8px'
              }}>
                <div style={{ fontSize: '13px', color: '#6b7280', marginBottom: '5px' }}>
                  Actions Totales
                </div>
                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#1a202c' }}>
                  {agSgis.reduce((acc, sgi) => acc + sgi.total_actions, 0).toLocaleString()}
                </div>
              </div>
            </div>
          </div>

          <div style={{
            background: 'white',
            padding: '30px',
            borderRadius: '12px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h3 style={{ fontSize: '20px', color: '#1a202c', marginBottom: '20px' }}>
              SGI présents à l'assemblée ({agSgis.length})
            </h3>

            <div style={{ 
              display: 'grid', 
              gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', 
              gap: '20px' 
            }}>
              {agSgis.map((sgi, index) => {
                const colors = [
                  { bg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', light: '#e0e7ff', text: '#4338ca' },
                  { bg: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', light: '#fce7f3', text: '#be185d' },
                  { bg: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', light: '#dbeafe', text: '#0369a1' },
                  { bg: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', light: '#d1fae5', text: '#065f46' },
                  { bg: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', light: '#fef3c7', text: '#92400e' }
                ];
                const colorScheme = colors[index % colors.length];
                const sgiFiles = fichiers.filter(f => f.sgi_id === sgi.sgi_id);

                return (
                  <div 
                    key={sgi.id}
                    onClick={() => handleSgiClick(sgi)}
                    style={{
                      background: 'white',
                      border: `2px solid ${colorScheme.light}`,
                      borderRadius: '16px',
                      overflow: 'hidden',
                      cursor: 'pointer',
                      transition: 'all 0.3s ease'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.transform = 'translateY(-8px)';
                      e.currentTarget.style.boxShadow = `0 12px 24px ${colorScheme.light}`;
                      e.currentTarget.style.borderColor = colorScheme.text;
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.transform = 'translateY(0)';
                      e.currentTarget.style.boxShadow = 'none';
                      e.currentTarget.style.borderColor = colorScheme.light;
                    }}
                  >
                    <div style={{
                      background: colorScheme.bg,
                      padding: '25px',
                      position: 'relative'
                    }}>
                      <div style={{
                        background: 'rgba(255,255,255,0.3)',
                        backdropFilter: 'blur(10px)',
                        width: '60px',
                        height: '60px',
                        borderRadius: '15px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        marginBottom: '15px'
                      }}>
                        <TrendingUp size={30} color="white" />
                      </div>
                      <h4 style={{
                        fontSize: '18px',
                        fontWeight: '700',
                        color: 'white',
                        marginBottom: '8px',
                        margin: 0
                      }}>
                        {sgi.nom_sgi}
                      </h4>
                      <div style={{
                        color: 'rgba(255,255,255,0.9)',
                        fontSize: '13px',
                        marginTop: '8px'
                      }}>
                        ID: {sgi.sgi_id}
                      </div>
                    </div>

                    <div style={{ padding: '25px' }}>
                      <div style={{
                        display: 'grid',
                        gridTemplateColumns: '1fr 1fr 1fr',
                        gap: '12px',
                        marginBottom: '20px'
                      }}>
                        <div style={{
                          background: colorScheme.light,
                          padding: '12px',
                          borderRadius: '8px',
                          textAlign: 'center'
                        }}>
                          <div style={{ fontSize: '18px', fontWeight: 'bold', color: colorScheme.text, marginBottom: '4px' }}>
                            {sgi.participants_count}
                          </div>
                          <div style={{ fontSize: '11px', color: colorScheme.text, fontWeight: '500' }}>
                            Participants
                          </div>
                        </div>
                        <div style={{
                          background: colorScheme.light,
                          padding: '12px',
                          borderRadius: '8px',
                          textAlign: 'center'
                        }}>
                          <div style={{ fontSize: '18px', fontWeight: 'bold', color: colorScheme.text, marginBottom: '4px' }}>
                            {(sgi.total_actions / 1000).toFixed(0)}K
                          </div>
                          <div style={{ fontSize: '11px', color: colorScheme.text, fontWeight: '500' }}>
                            Actions
                          </div>
                        </div>
                        <div style={{
                          background: colorScheme.light,
                          padding: '12px',
                          borderRadius: '8px',
                          textAlign: 'center'
                        }}>
                          <div style={{ fontSize: '18px', fontWeight: 'bold', color: colorScheme.text, marginBottom: '4px' }}>
                            {sgiFiles.length}
                          </div>
                          <div style={{ fontSize: '11px', color: colorScheme.text, fontWeight: '500' }}>
                            Fichiers
                          </div>
                        </div>
                      </div>

                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '8px',
                        color: colorScheme.text,
                        fontSize: '14px',
                        fontWeight: '600',
                        paddingTop: '10px',
                        borderTop: `1px solid ${colorScheme.light}`
                      }}>
                        <FolderOpen size={16} />
                        Voir les fichiers ({sgiFiles.length})
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    // Vue principale des AG (liste)
    return (
      <div style={{ padding: '40px' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px' }}>
          <h2 style={{ fontSize: '28px', color: '#1a202c' }}>Assemblées Générales</h2>
          <button
            onClick={() => openModal('ag')}
            style={{
              background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              color: 'white',
              border: 'none',
              padding: '12px 24px',
              borderRadius: '8px',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              fontSize: '14px',
              fontWeight: '500',
              boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}
          >
            <Plus size={18} />
            Nouvelle AG
          </button>
        </div>

        <div style={{ 
          display: 'grid', 
          gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', 
          gap: '25px' 
        }}>
          {ags.map((ag) => (
            <div 
              key={ag.id} 
              onClick={() => {
                setSelectedAg(ag);
                pushNavigation('ag', ag);
              }}
              style={{
                background: 'white',
                borderRadius: '12px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                overflow: 'hidden',
                cursor: 'pointer',
                transition: 'all 0.3s ease'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.transform = 'translateY(-5px)';
                e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
              }}
            >
              <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                padding: '25px',
                position: 'relative'
              }}>
                <div style={{
                  position: 'absolute',
                  top: '15px',
                  right: '15px',
                  background: 'rgba(255,255,255,0.2)',
                  padding: '6px 12px',
                  borderRadius: '20px',
                  fontSize: '12px',
                  color: 'white',
                  fontWeight: '500'
                }}>
                  {new Date(ag.date_ag).toLocaleDateString('fr-FR')}
                </div>
                <div style={{
                  background: 'white',
                  width: '60px',
                  height: '60px',
                  borderRadius: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  marginBottom: '15px'
                }}>
                  <Calendar size={30} color="#667eea" />
                </div>
                <h3 style={{
                  fontSize: '20px',
                  fontWeight: 'bold',
                  color: 'white',
                  marginBottom: '8px'
                }}>
                  {ag.code_ag}
                </h3>
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  color: 'rgba(255,255,255,0.9)',
                  fontSize: '14px'
                }}>
                  <Building2 size={16} />
                  {ag.nom_entreprise}
                </div>
              </div>

              <div style={{ padding: '25px' }}>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: '1fr 1fr 1fr',
                  gap: '15px',
                  marginBottom: '20px'
                }}>
                  <div style={{
                    background: '#f0f9ff',
                    padding: '15px',
                    borderRadius: '8px',
                    textAlign: 'center'
                  }}>
                    <div style={{
                      fontSize: '12px',
                      color: '#0369a1',
                      marginBottom: '5px',
                      fontWeight: '500'
                    }}>
                      SGI
                    </div>
                    <div style={{
                      fontSize: '20px',
                      fontWeight: 'bold',
                      color: '#0c4a6e'
                    }}>
                      {ag.sgi_count}
                    </div>
                  </div>
                  <div style={{
                    background: '#f0fdf4',
                    padding: '15px',
                    borderRadius: '8px',
                    textAlign: 'center'
                  }}>
                    <div style={{
                      fontSize: '12px',
                      color: '#15803d',
                      marginBottom: '5px',
                      fontWeight: '500'
                    }}>
                      Participants
                    </div>
                    <div style={{
                      fontSize: '20px',
                      fontWeight: 'bold',
                      color: '#14532d'
                    }}>
                      {ag.participants_count}
                    </div>
                  </div>
                  <div style={{
                    background: '#fef7cd',
                    padding: '15px',
                    borderRadius: '8px',
                    textAlign: 'center'
                  }}>
                    <div style={{
                      fontSize: '12px',
                      color: '#a16207',
                      marginBottom: '5px',
                      fontWeight: '500'
                    }}>
                      Fichiers
                    </div>
                    <div style={{
                      fontSize: '20px',
                      fontWeight: 'bold',
                      color: '#713f12'
                    }}>
                      {ag.fichiers_count}
                    </div>
                  </div>
                </div>

                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '8px',
                  color: '#667eea',
                  fontSize: '14px',
                  fontWeight: '600',
                  paddingTop: '10px',
                  borderTop: '1px solid #e5e7eb'
                }}>
                  <Eye size={16} />
                  Voir les SGI participants
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  };

  // Modal amélioré
  const Modal = () => {
    const [formData, setFormData] = useState({});

    const handleSubmit = () => {
      console.log('Form submitted:', formData);
      
      if (modalType === 'entreprise') {
        const newEntreprise = {
          id: entreprises.length + 1,
          entreprise_id: entreprises.length + 1,
          nom_entreprise: formData.nom_entreprise,
          created_at: new Date().toISOString().split('T')[0]
        };
        setEntreprises([...entreprises, newEntreprise]);
      } else if (modalType === 'ag') {
        const newAg = {
          id: ags.length + 1,
          code_ag: formData.code_ag,
          date_ag: formData.date_ag,
          entreprise_id: parseInt(formData.entreprise_id),
          nom_entreprise: entreprises.find(e => e.entreprise_id === parseInt(formData.entreprise_id))?.nom_entreprise,
          fichiers_count: 0,
          participants_count: 0,
          sgi_count: 0
        };
        setAgs([...ags, newAg]);
      }
      
      closeModal();
    };

    const handleFileUploadSubmit = () => {
      const fileInput = document.getElementById('file-upload-input');
      const file = fileInput.files[0];
      
      if (file && selectedSgi) {
        handleFileUpload(file, selectedAg.id, selectedSgi.sgi_id);
        closeModal();
      } else {
        alert('Veuillez sélectionner un fichier');
      }
    };

    if (!showModal) return null;

    return (
      <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.5)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 1000
      }}
      onClick={closeModal}
      >
        <div 
          style={{
            background: 'white',
            borderRadius: '12px',
            padding: '30px',
            maxWidth: '500px',
            width: '90%',
            maxHeight: '90vh',
            overflow: 'auto',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
          }}
          onClick={(e) => e.stopPropagation()}
        >
          <h3 style={{ fontSize: '24px', marginBottom: '20px', color: '#1a202c' }}>
            {modalType === 'entreprise' ? 'Créer une Entreprise' : 
             modalType === 'ag' ? 'Créer une Assemblée Générale' :
             modalType === 'upload-sgi' ? 'Upload Fichier pour SGI' : 'Modal'}
          </h3>
          
          <div>
            {modalType === 'upload-sgi' ? (
              <>
                <div style={{
                  background: '#f0f9ff',
                  padding: '15px',
                  borderRadius: '8px',
                  marginBottom: '20px'
                }}>
                  <div style={{ fontSize: '14px', color: '#1e40af', marginBottom: '5px' }}>
                    Fichier associé à:
                  </div>
                  <div style={{ fontSize: '16px', fontWeight: 'bold', color: '#1d4ed8' }}>
                    {selectedSgi.nom_sgi} ({selectedSgi.sgi_id})
                  </div>
                  <div style={{ fontSize: '14px', color: '#2563eb' }}>
                    AG: {selectedAg.code_ag}
                  </div>
                </div>
                <div style={{ marginBottom: '20px' }}>
                  <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Fichier *
                  </label>
                  <input
                    id="file-upload-input"
                    type="file"
                    accept=".xlsx,.csv,.pdf,.xls"
                    style={{
                      width: '100%',
                      padding: '12px',
                      borderRadius: '8px',
                      border: '1px solid #e5e7eb',
                      fontSize: '14px',
                      outline: 'none'
                    }}
                  />
                </div>
                {loading && (
                  <div style={{
                    background: '#f0f9ff',
                    padding: '20px',
                    borderRadius: '8px',
                    marginBottom: '20px',
                    textAlign: 'center'
                  }}>
                    <div style={{ marginBottom: '10px' }}>Upload en cours...</div>
                    <div style={{
                      background: '#e5e7eb',
                      borderRadius: '10px',
                      height: '8px',
                      overflow: 'hidden'
                    }}>
                      <div style={{
                        background: '#667eea',
                        height: '100%',
                        width: `${uploadProgress}%`,
                        transition: 'width 0.3s ease'
                      }}></div>
                    </div>
                    <div style={{ marginTop: '10px', fontSize: '14px' }}>{uploadProgress}%</div>
                  </div>
                )}
              </>
            ) : modalType === 'entreprise' ? (
              <>
                <div style={{ marginBottom: '20px' }}>
                  <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Nom de l'entreprise *
                  </label>
                  <input
                    type="text"
                    onChange={(e) => setFormData({...formData, nom_entreprise: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '12px',
                      borderRadius: '8px',
                      border: '1px solid #e5e7eb',
                      fontSize: '14px',
                      outline: 'none'
                    }}
                    placeholder="Ex: TechCorp SA"
                  />
                </div>
              </>
            ) : (
              <>
                <div style={{ marginBottom: '20px' }}>
                  <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Code AG *
                  </label>
                  <input
                    type="text"
                    onChange={(e) => setFormData({...formData, code_ag: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '12px',
                      borderRadius: '8px',
                      border: '1px solid #e5e7eb',
                      fontSize: '14px',
                      outline: 'none'
                    }}
                    placeholder="Ex: AG2026-003"
                  />
                </div>
                <div style={{ marginBottom: '20px' }}>
                  <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Date de l'AG *
                  </label>
                  <input
                    type="date"
                    onChange={(e) => setFormData({...formData, date_ag: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '12px',
                      borderRadius: '8px',
                      border: '1px solid #e5e7eb',
                      fontSize: '14px',
                      outline: 'none'
                    }}
                  />
                </div>
                <div style={{ marginBottom: '20px' }}>
                  <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Entreprise *
                  </label>
                  <select
                    onChange={(e) => setFormData({...formData, entreprise_id: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '12px',
                      borderRadius: '8px',
                      border: '1px solid #e5e7eb',
                      fontSize: '14px',
                      outline: 'none'
                    }}
                  >
                    <option value="">Sélectionner une entreprise</option>
                    {entreprises.map(e => (
                      <option key={e.id} value={e.entreprise_id}>{e.nom_entreprise}</option>
                    ))}
                  </select>
                </div>
              </>
            )}

            <div style={{ display: 'flex', gap: '10px', marginTop: '30px' }}>
              <button
                onClick={closeModal}
                style={{
                  flex: 1,
                  background: '#f3f4f6',
                  color: '#374151',
                  border: 'none',
                  padding: '12px',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '500'
                }}
              >
                Annuler
              </button>
              <button
                onClick={modalType === 'upload-sgi' ? handleFileUploadSubmit : handleSubmit}
                disabled={loading}
                style={{
                  flex: 1,
                  background: loading ? '#9ca3af' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  color: 'white',
                  border: 'none',
                  padding: '12px',
                  borderRadius: '8px',
                  cursor: loading ? 'not-allowed' : 'pointer',
                  fontSize: '14px',
                  fontWeight: '500'
                }}
              >
                {modalType === 'upload-sgi' ? 'Upload' : 'Créer'}
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  // Les autres vues simplifiées
  const EntreprisesView = () => <div style={{ padding: '40px' }}><h2>Entreprises - Interface simplifiée</h2></div>;
  const ActionnairesView = () => <div style={{ padding: '40px' }}><h2>Actionnaires - En développement</h2></div>;
  const ParticipantsView = () => <div style={{ padding: '40px' }}><h2>Participants - En développement</h2></div>;
  const RapportsView = () => <div style={{ padding: '40px' }}><h2>Rapports - En développement</h2></div>;

  return (
    <div style={{ 
      minHeight: '100vh', 
      background: '#f3f4f6',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
    }}>
      <style jsx>{`
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `}</style>
      
      <Navigation />
      <Breadcrumb />
      
      {currentView === 'dashboard' && <Dashboard />}
      {currentView === 'entreprises' && <EntreprisesView />}
      {currentView === 'ags' && <AGsView />}
      {currentView === 'actionnaires' && <ActionnairesView />}
      {currentView === 'participants' && <ParticipantsView />}
      {currentView === 'rapports' && <RapportsView />}
      
      <Modal />
    </div>
  );
};

export default App;
